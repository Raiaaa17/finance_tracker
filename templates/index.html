<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 47% 33%, hsl(214.74, 95%, 77%) 0, transparent 59%), 
                radial-gradient(at 82% 65%, hsl(218.00, 39%, 11%) 0, transparent 55%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .expense-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            background: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .expense-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.3);
            background: rgba(17, 24, 39, 0.8);
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.3);
        }

        .modal {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal:not(.hidden) .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(79, 70, 229, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #1E293B 0%, #334155 100%);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(30, 41, 59, 0.5);
        }

        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        .chart-container {
            position: relative;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: scale(1.02);
        }

        .category-tag {
            transition: all 0.2s ease;
        }

        .category-tag:hover {
            transform: scale(1.05);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.5);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.7);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 text-gray-100">
    <div class="p-6">
        <div class="max-w-7xl mx-auto">
            <header class="flex justify-between items-center mb-8 glass-card rounded-2xl p-6">
                <div>
                    <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                        Finance Dashboard
                    </h1>
                    <p class="text-gray-400 mt-2">Track and analyze your expenses with style</p>
                </div>
                <div class="flex space-x-4">
                    <button
                        onclick="openAllExpenses()"
                        class="btn-secondary text-white px-6 py-3 rounded-xl flex items-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        <span>View All</span>
                    </button>
                    <button
                        onclick="openAddExpenseModal()"
                        class="btn-primary text-white px-6 py-3 rounded-xl flex items-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span>Add Expense</span>
                    </button>
                </div>
            </header>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Expenses -->
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-400">Total Expenses</h3>
                        <span class="text-emerald-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </span>
                    </div>
                    <p class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-blue-500">
                        ${{ "%.2f"|format(dashboard.total_expenses) }}
                    </p>
                    <p class="text-sm text-gray-400 mt-2">All time total</p>
                </div>

                <!-- Monthly Expenses -->
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-400">This Month</h3>
                        <span class="text-blue-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </span>
                    </div>
                    <p class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">
                        ${{ "%.2f"|format(dashboard.current_month_total) }}
                    </p>
                    <p class="text-sm {% if dashboard.mom_growth >= 0 %}text-emerald-400{% else %}text-red-400{% endif %} mt-2">
                        {{ "%.1f"|format(dashboard.mom_growth) }}% from last month
                    </p>
                </div>

                <!-- Daily Average -->
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-400">Daily Average</h3>
                        <span class="text-purple-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </span>
                    </div>
                    <p class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500">
                        ${{ "%.2f"|format(dashboard.avg_daily_expense) }}
                    </p>
                    <p class="text-sm text-gray-400 mt-2">Last 30 days</p>
                </div>

                <!-- Categories -->
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-400">Categories</h3>
                        <span class="text-amber-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                            </svg>
                        </span>
                    </div>
                    <p class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-400 to-orange-500">
                        {{ dashboard.category_totals|length }}
                    </p>
                    <p class="text-sm text-gray-400 mt-2">Active categories</p>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-3 gap-6 mb-8">
                <!-- Monthly Trend -->
                <div class="col-span-2 glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">Expense Trend</h3>
                        <div class="flex space-x-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-400">View:</label>
                                <select id="timeRangeSelect" onchange="updateTrendChart()" class="bg-gray-800 text-gray-200 text-sm border border-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-400">Categories:</label>
                                <div class="relative">
                                    <button 
                                        onclick="toggleCategoryDropdown()" 
                                        type="button" 
                                        class="bg-gray-800 text-gray-200 text-sm border border-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center"
                                    >
                                        <span id="selectedCategoriesText">All Categories</span>
                                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div id="categoryDropdown" class="hidden absolute z-10 mt-2 w-48 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                                        <div class="p-2 space-y-1">
                                            <label class="flex items-center p-2 hover:bg-gray-700 rounded-lg cursor-pointer">
                                                <input type="checkbox" id="categoryAll" checked onchange="handleCategoryAllChange(this)" class="rounded border-gray-600 text-indigo-500 focus:ring-indigo-500 bg-gray-700">
                                                <span class="ml-2 text-sm text-gray-200">All Categories</span>
                                            </label>
                                            <div class="border-t border-gray-700 my-1"></div>
                                            {% for category in categories %}
                                            <label class="flex items-center p-2 hover:bg-gray-700 rounded-lg cursor-pointer">
                                                <input type="checkbox" value="{{ category }}" onchange="handleCategoryChange(this)" class="category-checkbox rounded border-gray-600 text-indigo-500 focus:ring-indigo-500 bg-gray-700">
                                                <span class="ml-2 text-sm text-gray-200">{{ category }}</span>
                                            </label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- Category Distribution -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500 mb-6">Category Distribution</h3>
                    <div class="chart-container" style="min-height: 300px;">
                        <canvas id="categoryDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="grid grid-cols-3 gap-6">
                <div class="col-span-2 glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-teal-500">Recent Transactions</h3>
                        <div class="flex space-x-4">
                            <button
                                onclick="openAllExpenses()"
                                class="text-sm text-indigo-400 hover:text-indigo-300 transition-colors flex items-center space-x-1"
                            >
                                <span>View All</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                            <button
                                onclick="openAddExpenseModal()"
                                class="btn-primary text-white px-4 py-2 rounded-xl flex items-center space-x-2 text-sm"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                <span>Add New</span>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-4 custom-scrollbar" style="max-height: 480px; overflow-y: auto;">
                        {% if dashboard.recent_expenses %}
                            {% for expense in dashboard.recent_expenses %}
                            <div class="expense-card bg-gray-800 bg-opacity-50 rounded-xl p-4 border border-gray-700">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-medium text-gray-200">{{ expense.name }}</h4>
                                        <p class="text-sm text-gray-400">{{ expense.description }}</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <span class="font-medium text-gray-200">${{ "%.2f"|format(expense.amount) }}</span>
                                        <div class="flex space-x-2">
                                            <button 
                                                onclick='editExpense({{ expense.id|tojson|safe }}, {{ expense.name|tojson|safe }}, {{ expense.amount }}, {{ expense.category|tojson|safe }}, {{ expense.description|tojson|safe }}, {{ expense.created_at|tojson|safe }})'
                                                class="text-indigo-400 hover:text-indigo-300 transition-colors p-1"
                                            >
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                            </button>
                                            <button 
                                                onclick="showDeleteConfirmation('{{ expense.id }}', '{{ expense.name }}', {{ expense.amount }}, '{{ expense.category }}')"
                                                class="text-red-400 hover:text-red-300 transition-colors p-1"
                                            >
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="category-tag inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-900 text-indigo-200">
                                        {{ expense.category }}
                                    </span>
                                    <span class="text-xs text-gray-400">
                                        {{ expense.created_at.split('T')[0] }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8">
                                <svg class="w-16 h-16 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                                <p class="text-gray-400">No recent transactions</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Additional Stats -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-amber-400 to-orange-500 mb-6">Top Categories</h3>
                    <div class="space-y-4">
                        {% for category, amount in dashboard.top_categories %}
                        <div class="flex justify-between items-center p-3 bg-gray-800 bg-opacity-50 rounded-xl border border-gray-700">
                            <span class="text-sm text-gray-300">{{ category }}</span>
                            <span class="font-medium text-gray-200">${{ "%.2f"|format(amount) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full z-40">
        <div class="relative top-20 mx-auto p-6 border w-96 shadow-lg rounded-2xl glass-card">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">Add New Expense</h3>
                    <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-300 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="addExpenseForm" class="space-y-4">
                    <div>
                        <label for="expenseDescription" class="block text-sm font-medium text-gray-300 mb-1">
                            Expense Description
                        </label>
                        <textarea
                            id="expenseDescription"
                            class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200 placeholder-gray-500"
                            rows="3"
                            placeholder="Describe your expense (e.g., 'Lunch at Subway for $12.99')"
                            required
                        ></textarea>
                    </div>
                    <div>
                        <label for="expenseDate" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input 
                            type="date" 
                            id="expenseDate" 
                            class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200"
                            value="{{ today_date }}"
                            required
                        >
                    </div>
                    <div id="analysisResult" class="hidden space-y-3 p-4 bg-gray-800 bg-opacity-50 rounded-xl border border-gray-700">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm font-medium text-gray-400">Name</p>
                                <p id="expenseName" class="mt-1 text-gray-200"></p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-400">Amount</p>
                                <p id="expenseAmount" class="mt-1 text-gray-200 font-medium"></p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-400">Category</p>
                                <p id="expenseCategory" class="mt-1 text-gray-200"></p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeAddModal()" class="btn-secondary text-white px-4 py-2 rounded-xl">
                            Cancel
                        </button>
                        <button 
                            onclick="analyzeExpense()" 
                            id="analyzeButton"
                            class="btn-primary text-white px-4 py-2 rounded-xl"
                        >
                            Analyze & Add
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-6 border w-96 shadow-lg rounded-2xl glass-card">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">Edit Expense</h3>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-300 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="editForm" class="space-y-4">
                    <input type="hidden" id="editExpenseId">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                        <input type="text" id="editName" required class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Amount</label>
                        <input type="number" step="0.01" min="0.01" id="editAmount" required class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Category</label>
                        <select id="editCategory" required class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200">
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                        <textarea id="editDescription" required rows="2" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input 
                            type="date" 
                            id="editDate" 
                            required 
                            class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200"
                        >
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeEditModal()" class="btn-secondary text-white px-4 py-2 rounded-xl">Cancel</button>
                        <button type="submit" class="btn-primary text-white px-4 py-2 rounded-xl">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- All Expenses Modal -->
    <div id="allExpensesModal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full z-40">
        <div class="relative top-10 mx-auto p-6 border w-3/4 max-w-4xl shadow-lg rounded-2xl glass-card">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">All Expenses</h3>
                    <button onclick="closeAllExpensesModal()" class="text-gray-400 hover:text-gray-300 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="col-span-1 md:col-span-2">
                        <input 
                            type="text" 
                            id="expenseSearch" 
                            placeholder="Search by name or description..." 
                            class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200 placeholder-gray-500"
                            oninput="filterExpenses()"
                        >
                    </div>
                    <div>
                        <select 
                            id="categoryFilter" 
                            class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200"
                            onchange="filterExpenses()"
                        >
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <select 
                            id="sortFilter" 
                            class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200"
                            onchange="filterExpenses()"
                        >
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="amount-desc">Highest Amount</option>
                            <option value="amount-asc">Lowest Amount</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm text-gray-400 mb-1">Start Date</label>
                                <input 
                                    type="date" 
                                    id="startDate" 
                                    class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200"
                                    onchange="filterExpenses()"
                                >
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm text-gray-400 mb-1">End Date</label>
                                <input 
                                    type="date" 
                                    id="endDate" 
                                    class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200"
                                    onchange="filterExpenses()"
                                >
                            </div>
                        </div>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <div class="flex space-x-2">
                            <button 
                                onclick="setDateRange('today')" 
                                class="px-3 py-1 text-sm bg-gray-800 border border-gray-700 rounded-xl hover:bg-gray-700 text-gray-200"
                            >Today</button>
                            <button 
                                onclick="setDateRange('week')" 
                                class="px-3 py-1 text-sm bg-gray-800 border border-gray-700 rounded-xl hover:bg-gray-700 text-gray-200"
                            >This Week</button>
                            <button 
                                onclick="setDateRange('month')" 
                                class="px-3 py-1 text-sm bg-gray-800 border border-gray-700 rounded-xl hover:bg-gray-700 text-gray-200"
                            >This Month</button>
                            <button 
                                onclick="setDateRange('year')" 
                                class="px-3 py-1 text-sm bg-gray-800 border border-gray-700 rounded-xl hover:bg-gray-700 text-gray-200"
                            >This Year</button>
                            <button 
                                onclick="clearDateRange()" 
                                class="px-3 py-1 text-sm bg-gray-800 border border-red-700 rounded-xl hover:bg-gray-700 text-red-400"
                            >Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Expenses Table -->
                <div class="overflow-x-auto bg-gray-800 bg-opacity-50 rounded-xl border border-gray-700">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Category</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allExpensesTableBody" class="divide-y divide-gray-700">
                            <!-- Expenses will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center mt-6">
                    <div class="text-sm text-gray-400" id="expenseCount"></div>
                    <div class="flex space-x-2">
                        <button id="prevPage" onclick="changePage(-1)" class="px-3 py-1 bg-gray-800 border border-gray-700 rounded-xl hover:bg-gray-700 text-gray-200">Previous</button>
                        <span id="currentPage" class="px-3 py-1 text-gray-200">Page 1</span>
                        <button id="nextPage" onclick="changePage(1)" class="px-3 py-1 bg-gray-800 border border-gray-700 rounded-xl hover:bg-gray-700 text-gray-200">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-6 border w-96 shadow-lg rounded-2xl glass-card">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-pink-500">Delete Expense</h3>
                    <button onclick="closeDeleteModal()" class="text-gray-400 hover:text-gray-300 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mb-6">
                    <p class="text-gray-300">Are you sure you want to delete this expense?</p>
                    <div class="mt-4 bg-gray-800 bg-opacity-50 rounded-xl p-4 border border-gray-700">
                        <div class="mb-2">
                            <span class="text-sm text-gray-400">Name:</span>
                            <span id="deleteExpenseName" class="ml-2 text-gray-200"></span>
                        </div>
                        <div class="mb-2">
                            <span class="text-sm text-gray-400">Amount:</span>
                            <span id="deleteExpenseAmount" class="ml-2 text-gray-200"></span>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">Category:</span>
                            <span id="deleteExpenseCategory" class="ml-2 text-gray-200"></span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeDeleteModal()" class="btn-secondary text-white px-4 py-2 rounded-xl">
                        Cancel
                    </button>
                    <button 
                        id="confirmDeleteButton"
                        class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-4 py-2 rounded-xl hover:from-red-600 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all transform hover:scale-105"
                    >
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Color palette for different categories with new modern colors
        const categoryColors = {
            'Food & Dining': 'rgba(99, 102, 241, 0.8)',      // Indigo
            'Transportation': 'rgba(16, 185, 129, 0.8)',      // Emerald
            'Shopping': 'rgba(245, 158, 11, 0.8)',           // Amber
            'Bills & Utilities': 'rgba(139, 92, 246, 0.8)',  // Purple
            'Entertainment': 'rgba(236, 72, 153, 0.8)'       // Pink
        };

        // Initialize data
        window.DASHBOARD_DATA = {
            timeSeries: {{ dashboard.time_series|tojson|safe }},
            categoryTotals: {{ dashboard.category_totals|tojson|safe }},
            categories: {{ categories|tojson|safe }}
        };

        // Initialize time series data
        const timeSeriesData = window.DASHBOARD_DATA.timeSeries;
        const categoryData = window.DASHBOARD_DATA.categoryTotals;

        // Category selection state
        let selectedCategories = new Set(['total']);

        // Handle category dropdown
        function toggleCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('categoryDropdown');
            const button = event.target.closest('button');
            if (!button && !event.target.closest('#categoryDropdown')) {
                dropdown.classList.add('hidden');
            }
        });

        function handleCategoryAllChange(checkbox) {
            const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
            categoryCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                cb.disabled = checkbox.checked;
            });
            
            selectedCategories.clear();
            if (checkbox.checked) {
                selectedCategories.add('total');
            }
            
            updateSelectedCategoriesText();
            updateTrendChart();
        }

        function handleCategoryChange(checkbox) {
            const allCheckbox = document.getElementById('categoryAll');
            const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
            const checkedCategories = Array.from(categoryCheckboxes).filter(cb => cb.checked);
            
            selectedCategories.clear();
            if (checkedCategories.length === 0) {
                allCheckbox.checked = true;
                categoryCheckboxes.forEach(cb => cb.disabled = true);
                selectedCategories.add('total');
            } else {
                allCheckbox.checked = false;
                categoryCheckboxes.forEach(cb => cb.disabled = false);
                checkedCategories.forEach(cb => selectedCategories.add(cb.value));
            }
            
            updateSelectedCategoriesText();
            updateTrendChart();
        }

        function updateSelectedCategoriesText() {
            const text = document.getElementById('selectedCategoriesText');
            if (selectedCategories.has('total')) {
                text.textContent = 'All Categories';
            } else {
                const count = selectedCategories.size;
                text.textContent = count === 1 
                    ? Array.from(selectedCategories)[0]
                    : `${count} Categories`;
            }
        }

        // Format date for display
        function formatDate(dateStr, period) {
            if (period === 'weekly') {
                const [year, week] = dateStr.split('-W');
                const date = new Date(year, 0, 1 + (week - 1) * 7);
                return `Week ${week}, ${date.toLocaleDateString('default', { month: 'short' })}`;
            }
            
            const date = new Date(dateStr.replace('W', '-'));
            if (period === 'daily') {
                return date.toLocaleDateString('default', { month: 'short', day: 'numeric' });
            } else {
                return date.toLocaleDateString('default', { month: 'short', year: 'numeric' });
            }
        }

        // Initialize trend chart with new modern design
        let trendChart = null;

        function updateTrendChart() {
            const period = document.getElementById('timeRangeSelect').value;
            const ctx = document.getElementById('trendChart').getContext('2d');

            let datasets = [];
            if (selectedCategories.has('total')) {
                datasets.push({
                    label: 'Total Expenses',
                    data: timeSeriesData[period].total.map(([_, amount]) => amount),
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true
                });
            } else {
                datasets = Array.from(selectedCategories).map(category => ({
                    label: category,
                    data: (timeSeriesData[period].by_category[category] || []).map(([_, amount]) => amount),
                    borderColor: categoryColors[category] || 'rgb(156, 163, 175)',
                    backgroundColor: 'transparent',
                    tension: 0.4,
                    fill: false
                }));
            }

            const chartData = {
                labels: timeSeriesData[period].total.map(([date]) => formatDate(date, period)),
                datasets: datasets
            };

            if (trendChart) {
                trendChart.destroy();
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: !selectedCategories.has('total'),
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15,
                                color: 'rgb(209, 213, 219)'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                }
                            },
                            backgroundColor: 'rgba(17, 24, 39, 0.8)',
                            titleColor: 'rgb(229, 231, 235)',
                            bodyColor: 'rgb(229, 231, 235)',
                            borderColor: 'rgb(75, 85, 99)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: 'rgb(156, 163, 175)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: 'rgb(156, 163, 175)',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateTrendChart();
            
            // Initialize category distribution chart with new modern design
            const categoryCtx = document.getElementById('categoryDistributionChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: Object.values(categoryColors),
                        borderColor: 'rgba(17, 24, 39, 0.8)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: {
                                    size: 11
                                },
                                color: 'rgb(209, 213, 219)'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.8)',
                            titleColor: 'rgb(229, 231, 235)',
                            bodyColor: 'rgb(229, 231, 235)',
                            borderColor: 'rgb(75, 85, 99)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '70%',
                    radius: '90%'
                }
            });
        });

        // Set default date to today when opening add expense modal
        function openAddExpenseModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            document.getElementById('addExpenseModal').classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('addExpenseModal').classList.add('hidden');
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('analysisResult').classList.add('hidden');
            document.getElementById('analyzeButton').textContent = 'Analyze & Add';
            document.getElementById('analyzeButton').onclick = analyzeExpense;
        }

        function editExpense(id, name, amount, category, description, date) {
            try {
                document.getElementById('editExpenseId').value = id;
                document.getElementById('editName').value = name;
                document.getElementById('editAmount').value = amount;
                document.getElementById('editCategory').value = category;
                document.getElementById('editDescription').value = description;
                // Convert the date string to YYYY-MM-DD format
                const formattedDate = new Date(date).toISOString().split('T')[0];
                document.getElementById('editDate').value = formattedDate;
                document.getElementById('editModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error opening edit modal:', error);
                showToast('Error opening edit form', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 transform transition-transform duration-300 glass-card rounded-xl p-4 flex items-center space-x-3`;
            toast.style.transform = 'translateX(100%)';
            
            const icon = document.createElement('div');
            if (type === 'success') {
                icon.innerHTML = `
                    <svg class="h-6 w-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>`;
            } else {
                icon.innerHTML = `
                    <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>`;
            }
            
            const text = document.createElement('p');
            text.className = 'text-sm font-medium text-gray-200';
            text.textContent = message;
            
            toast.appendChild(icon);
            toast.appendChild(text);
            document.body.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.style.transform = 'translateX(0)';
            });
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function setLoading(elementId, isLoading) {
            const element = document.getElementById(elementId);
            if (isLoading) {
                element.classList.add('loading');
                if (element.tagName === 'BUTTON') {
                    element.disabled = true;
                }
                
                // Add loading animation
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center rounded-xl';
                loadingOverlay.innerHTML = `
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-400"></div>
                `;
                element.style.position = 'relative';
                element.appendChild(loadingOverlay);
            } else {
                element.classList.remove('loading');
                if (element.tagName === 'BUTTON') {
                    element.disabled = false;
                }
                
                // Remove loading animation
                const loadingOverlay = element.querySelector('.absolute');
                if (loadingOverlay) {
                    element.removeChild(loadingOverlay);
                }
            }
        }

        async function analyzeExpense() {
            const description = document.getElementById('expenseDescription').value.trim();
            const date = document.getElementById('expenseDate').value;
            
            if (!description) {
                showToast('Please enter an expense description', 'error');
                return;
            }
            
            if (!date) {
                showToast('Please select a date', 'error');
                return;
            }

            const button = document.getElementById('analyzeButton');
            const originalText = button.textContent;
            button.disabled = true;
            
            try {
                const response = await fetch('/api/analyze-expense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        description,
                        date
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    // Show analysis result
                    document.getElementById('analysisResult').classList.remove('hidden');
                    document.getElementById('expenseName').textContent = data.analysis.name;
                    document.getElementById('expenseAmount').textContent = `$${data.analysis.amount.toFixed(2)}`;
                    document.getElementById('expenseCategory').textContent = data.analysis.category;
                    
                    // Change button to "Confirm & Add"
                    button.textContent = 'Confirm & Add';
                    button.onclick = () => confirmAddExpense(data.analysis);
                } else {
                    throw new Error(data.error || 'Error analyzing expense');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Error processing expense', 'error');
                button.textContent = originalText;
                button.onclick = analyzeExpense;
            } finally {
                button.disabled = false;
            }
        }

        async function confirmAddExpense(analysis) {
            const date = document.getElementById('expenseDate').value;
            const button = document.getElementById('analyzeButton');
            button.disabled = true;
            
            try {
                const response = await fetch('/api/expense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: analysis.name,
                        amount: analysis.amount,
                        category: analysis.category,
                        description: document.getElementById('expenseDescription').value.trim(),
                        created_at: date
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    showToast('Expense added successfully');
                    closeAddModal();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Error adding expense');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Error adding expense', 'error');
            } finally {
                button.disabled = false;
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            setLoading(form.id, true);
            submitButton.disabled = true;
            
            const id = document.getElementById('editExpenseId').value;
            const editDate = document.getElementById('editDate').value;
            
            if (!editDate) {
                showToast('Please select a date', 'error');
                setLoading(form.id, false);
                submitButton.disabled = false;
                return;
            }
            
            const data = {
                id: id,
                name: document.getElementById('editName').value.trim(),
                amount: parseFloat(document.getElementById('editAmount').value),
                category: document.getElementById('editCategory').value,
                description: document.getElementById('editDescription').value.trim(),
                created_at: editDate // Use created_at instead of date to match the server's field name
            };

            try {
                const response = await fetch(`/api/expense/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    // Update the expense in allExpenses array if it exists
                    const index = allExpenses.findIndex(e => e.id === id);
                    if (index !== -1) {
                        allExpenses[index] = { ...allExpenses[index], ...data };
                        filteredExpenses = [...allExpenses];
                        filterExpenses();
                    }
                    
                    closeEditModal();
                    showToast('Expense updated successfully');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast(result.error || 'Error updating expense', 'error');
                }
            } catch (error) {
                showToast('Error updating expense', 'error');
                console.error('Error:', error);
            } finally {
                setLoading(form.id, false);
                submitButton.disabled = false;
            }
        });

        let expenseToDelete = null;

        async function deleteExpense(id) {
            try {
                const response = await fetch(`/api/expense/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Expense deleted successfully');
                    
                    // Remove from allExpenses array if it exists
                    const index = allExpenses.findIndex(e => e.id === id);
                    if (index !== -1) {
                        allExpenses.splice(index, 1);
                        filteredExpenses = [...allExpenses];
                        filterExpenses();
                    }
                    
                    // Refresh the main page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast(result.error || 'Error deleting expense', 'error');
                }
            } catch (error) {
                showToast('Error deleting expense', 'error');
                console.error('Error:', error);
            }
        }

        function showDeleteConfirmation(id, name, amount, category) {
            expenseToDelete = id;
            document.getElementById('deleteExpenseName').textContent = name;
            document.getElementById('deleteExpenseAmount').textContent = `$${amount.toFixed(2)}`;
            document.getElementById('deleteExpenseCategory').textContent = category;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
            
            // Set up the confirm delete button
            const confirmButton = document.getElementById('confirmDeleteButton');
            confirmButton.onclick = () => {
                deleteExpense(id);
                closeDeleteModal();
            };
        }

        function closeDeleteModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            expenseToDelete = null;
        }

        // Initialize delete buttons
        function initializeDeleteButtons() {
            const deleteButtons = document.querySelectorAll('[data-delete-expense]');
            deleteButtons.forEach(button => {
                button.onclick = () => {
                    const id = button.dataset.expenseId;
                    const name = button.dataset.expenseName;
                    const amount = parseFloat(button.dataset.expenseAmount);
                    const category = button.dataset.expenseCategory;
                    showDeleteConfirmation(id, name, amount, category);
                };
            });
        }

        // Initialize when page loads and after table updates
        document.addEventListener('DOMContentLoaded', function() {
            initializeDeleteButtons();
            updateTrendChart();
            
            // Initialize category distribution chart
            const categoryCtx = document.getElementById('categoryDistributionChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: Object.values(categoryColors),
                        borderColor: 'rgba(17, 24, 39, 0.8)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: {
                                    size: 11
                                },
                                color: 'rgb(209, 213, 219)'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.8)',
                            titleColor: 'rgb(229, 231, 235)',
                            bodyColor: 'rgb(229, 231, 235)',
                            borderColor: 'rgb(75, 85, 99)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '70%',
                    radius: '90%'
                }
            });
        });

        // Update initialization after table updates in the "View All" modal
        const originalUpdateExpensesTable = updateExpensesTable;
        updateExpensesTable = function() {
            originalUpdateExpensesTable.apply(this, arguments);
            initializeDeleteButtons();
        };

        // Add keyboard event listener to close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllExpensesModal();
                closeEditModal();
                closeDeleteModal();
            }
        });

        // Close modals when clicking outside
        document.getElementById('deleteConfirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        // All Expenses Modal Functions
        let allExpenses = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredExpenses = [];

        function openAllExpenses() {
            document.getElementById('allExpensesModal').classList.remove('hidden');
            setLoading('allExpensesTableBody', true);
            
            // Reset filters
            document.getElementById('expenseSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('sortFilter').value = 'date-desc';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            // Fetch expenses
            fetch('/api/expenses')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format received from server');
                    }
                    allExpenses = data;
                    filteredExpenses = [...allExpenses];
                    currentPage = 1;
                    filterExpenses();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error loading expenses: ' + error.message, 'error');
                })
                .finally(() => {
                    setLoading('allExpensesTableBody', false);
                });
        }

        function closeAllExpensesModal() {
            document.getElementById('allExpensesModal').classList.add('hidden');
        }

        function filterExpenses() {
            const searchTerm = document.getElementById('expenseSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            try {
                // Apply filters
                filteredExpenses = allExpenses.filter(expense => {
                    const matchesSearch = expense.name.toLowerCase().includes(searchTerm) ||
                                        expense.description.toLowerCase().includes(searchTerm);
                    const matchesCategory = !categoryFilter || expense.category === categoryFilter;
                    
                    // Date range filter
                    let matchesDate = true;
                    const expenseDate = expense.created_at.split('T')[0];
                    if (startDate && endDate) {
                        matchesDate = expenseDate >= startDate && expenseDate <= endDate;
                    } else if (startDate) {
                        matchesDate = expenseDate >= startDate;
                    } else if (endDate) {
                        matchesDate = expenseDate <= endDate;
                    }
                    
                    return matchesSearch && matchesCategory && matchesDate;
                });

                // Apply sorting
                filteredExpenses.sort((a, b) => {
                    switch (sortFilter) {
                        case 'date-desc':
                            return new Date(b.created_at) - new Date(a.created_at);
                        case 'date-asc':
                            return new Date(a.created_at) - new Date(b.created_at);
                        case 'amount-desc':
                            return b.amount - a.amount;
                        case 'amount-asc':
                            return a.amount - b.amount;
                        default:
                            return 0;
                    }
                });

                // Reset to first page and update table
                currentPage = 1;
                updateExpensesTable();
            } catch (error) {
                console.error('Error filtering expenses:', error);
                showToast('Error filtering expenses', 'error');
            }
        }

        function updateExpensesTable() {
            const tbody = document.getElementById('allExpensesTableBody');
            if (!tbody) return;

            try {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageExpenses = filteredExpenses.slice(startIndex, endIndex);

                tbody.innerHTML = '';

                if (pageExpenses.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">
                                No expenses found
                            </td>
                        </tr>
                    `;
                    return;
                }

                pageExpenses.forEach(expense => {
                    const formattedDate = new Date(expense.created_at).toLocaleDateString();
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-800 bg-opacity-50';
                    
                    const editParams = [
                        expense.id,
                        expense.name,
                        expense.amount,
                        expense.category,
                        expense.description,
                        expense.created_at
                    ].map(param => JSON.stringify(param)).join(', ');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                            ${formattedDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-200">${expense.name}</div>
                            <div class="text-sm text-gray-400">${expense.description}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="category-tag inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-900 text-indigo-200">
                                ${expense.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">
                            $${expense.amount.toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button 
                                onclick="editExpense(${editParams})"
                                class="text-indigo-400 hover:text-indigo-300 transition-colors mr-3"
                            >
                                Edit
                            </button>
                            <button 
                                data-delete-expense
                                data-expense-id="${expense.id}"
                                data-expense-name="${expense.name}"
                                data-expense-amount="${expense.amount.toFixed(2)}"
                                data-expense-category="${expense.category}"
                                class="text-red-400 hover:text-red-300 transition-colors"
                            >
                                Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Initialize delete buttons for the new rows
                initializeDeleteButtons();
            } catch (error) {
                console.error('Error updating expenses table:', error);
                showToast('Error updating expenses table', 'error');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-red-400">
                            Error loading expenses. Please try again.
                        </td>
                    </tr>
                `;
            }
        }
    </script>
</body>
</html> 